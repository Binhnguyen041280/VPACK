name: Build Desktop Apps

on:
  push:
    branches:
      - 'claude/Packaging-*'
      - 'main'
    paths:
      - 'desktop/**'
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/build-desktop.yml'
  pull_request:
    branches:
      - 'main'
    paths:
      - 'desktop/**'
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'Build Windows'
        required: false
        default: true
        type: boolean
      build_macos:
        description: 'Build macOS'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  # Build frontend first (shared between platforms)
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci --legacy-peer-deps
        working-directory: frontend

      - name: Build Next.js
        run: npm run build
        working-directory: frontend

      - name: Prepare standalone package
        run: |
          mkdir -p frontend-dist/standalone
          cp -r .next/standalone/* frontend-dist/standalone/
          mkdir -p frontend-dist/standalone/.next/static
          cp -r .next/static/* frontend-dist/standalone/.next/static/
          if [ -d "public" ]; then
            cp -r public frontend-dist/standalone/
          fi
        working-directory: frontend

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-standalone
          path: frontend/frontend-dist/
          retention-days: 7

  # Build Windows executable
  build-windows:
    name: Build Windows
    needs: build-frontend
    runs-on: windows-latest
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.build_windows }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            backend/requirements.txt
            desktop/requirements-desktop.txt

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-standalone
          path: frontend-dist/

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install -r desktop/requirements-desktop.txt
          pip install pyinstaller>=6.3.0

      - name: Build backend with PyInstaller
        run: |
          python -m PyInstaller --clean --distpath build/backend_dist --workpath build/backend_build vpack-backend.spec
        working-directory: desktop

      - name: Build launcher with PyInstaller
        run: |
          python -m PyInstaller --clean --distpath build/launcher_dist --workpath build/launcher_build vpack-launcher.spec
        working-directory: desktop

      - name: Assemble distribution
        shell: pwsh
        run: |
          # Create output directory
          New-Item -ItemType Directory -Force -Path dist/VPACK

          # Copy launcher
          if (Test-Path "build/launcher_dist/VPACK.exe") {
            Copy-Item "build/launcher_dist/VPACK.exe" "dist/VPACK/"
          } else {
            Copy-Item "build/launcher_dist/VPACK/*" "dist/VPACK/" -Recurse
          }

          # Copy backend
          Copy-Item "build/backend_dist/vpack-backend" "dist/VPACK/backend" -Recurse

          # Copy frontend
          New-Item -ItemType Directory -Force -Path dist/VPACK/frontend
          Copy-Item "../frontend-dist/standalone" "dist/VPACK/frontend/" -Recurse

          # Download Node.js
          $nodeVersion = "18.19.0"
          $nodeUrl = "https://nodejs.org/dist/v$nodeVersion/node-v$nodeVersion-win-x64.zip"
          Invoke-WebRequest -Uri $nodeUrl -OutFile "node.zip"
          Expand-Archive -Path "node.zip" -DestinationPath "node_temp"
          Copy-Item "node_temp/node-v$nodeVersion-win-x64/node.exe" "dist/VPACK/frontend/"

          # Create data directories
          New-Item -ItemType Directory -Force -Path dist/VPACK/data/database
          New-Item -ItemType Directory -Force -Path dist/VPACK/data/logs
          New-Item -ItemType Directory -Force -Path dist/VPACK/data/output

          # Copy resources if exists
          if (Test-Path "resources") {
            Copy-Item "resources" "dist/VPACK/" -Recurse
          }
        working-directory: desktop

      - name: Validate Windows build structure
        shell: pwsh
        run: |
          Write-Host "=========================================="
          Write-Host "VALIDATING VPACK WINDOWS BUILD"
          Write-Host "=========================================="

          # Check main executable
          Write-Host "✓ Checking main executable..."
          if (-not (Test-Path "dist/VPACK/VPACK.exe")) {
            Write-Error "❌ Main executable missing"
            exit 1
          }
          Write-Host "  ✅ Main executable OK"

          # Check backend
          Write-Host "✓ Checking backend..."
          if (-not (Test-Path "dist/VPACK/backend")) {
            Write-Error "❌ Backend directory missing"
            exit 1
          }
          if (-not (Test-Path "dist/VPACK/backend/vpack-backend.exe")) {
            Write-Error "❌ Backend executable missing"
            exit 1
          }
          Write-Host "  ✅ Backend OK"

          # Check frontend
          Write-Host "✓ Checking frontend..."
          if (-not (Test-Path "dist/VPACK/frontend/standalone")) {
            Write-Error "❌ Frontend standalone missing"
            exit 1
          }
          if (-not (Test-Path "dist/VPACK/frontend/standalone/server.js")) {
            Write-Error "❌ Frontend server.js missing"
            exit 1
          }
          if (-not (Test-Path "dist/VPACK/frontend/node.exe")) {
            Write-Error "❌ Node.exe missing"
            exit 1
          }
          Write-Host "  ✅ Frontend OK"

          # Summary
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "BUILD VALIDATION PASSED ✅"
          Write-Host "=========================================="
          Write-Host ""
          Write-Host "Main components:"
          Get-ChildItem -Path "dist/VPACK/VPACK.exe" | Format-Table Name, Length
          Get-ChildItem -Path "dist/VPACK/backend/vpack-backend.exe" | Format-Table Name, Length
          Get-ChildItem -Path "dist/VPACK/frontend/node.exe" | Format-Table Name, Length
        working-directory: desktop

      - name: Create ZIP archive
        shell: pwsh
        run: |
          Compress-Archive -Path dist/VPACK/* -DestinationPath dist/VPACK-${{ github.sha }}-Windows.zip
        working-directory: desktop

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: VPACK-Windows
          path: desktop/dist/VPACK-*-Windows.zip
          retention-days: 30

      - name: Upload Windows folder (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: VPACK-Windows-Folder
          path: desktop/dist/VPACK/
          retention-days: 7

  # Build macOS app
  build-macos:
    name: Build macOS
    needs: build-frontend
    runs-on: macos-latest
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.build_macos }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            backend/requirements.txt
            desktop/requirements-desktop.txt

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-standalone
          path: frontend-dist/

      - name: Install system dependencies
        run: |
          brew install create-dmg || true

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install -r desktop/requirements-desktop.txt
          pip install pyinstaller>=6.3.0

      - name: Build backend with PyInstaller
        run: |
          python -m PyInstaller --clean --distpath build/backend_dist --workpath build/backend_build vpack-backend.spec
        working-directory: desktop

      - name: Build launcher with PyInstaller
        run: |
          python -m PyInstaller --clean --distpath build/launcher_dist --workpath build/launcher_build vpack-launcher.spec
        working-directory: desktop

      - name: Assemble app bundle
        run: |
          # Create app bundle structure
          mkdir -p dist/VPACK.app/Contents/MacOS
          mkdir -p dist/VPACK.app/Contents/Resources

          # Create Info.plist
          cat > dist/VPACK.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>VPACK</string>
              <key>CFBundleDisplayName</key>
              <string>VPACK</string>
              <key>CFBundleIdentifier</key>
              <string>com.vpack.desktop</string>
              <key>CFBundleVersion</key>
              <string>1.0.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>CFBundleExecutable</key>
              <string>VPACK</string>
              <key>CFBundleIconFile</key>
              <string>icon</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>LSUIElement</key>
              <true/>
          </dict>
          </plist>
          EOF

          # Copy launcher
          if [ -f "build/launcher_dist/VPACK" ]; then
            cp build/launcher_dist/VPACK dist/VPACK.app/Contents/MacOS/
          elif [ -d "build/launcher_dist/VPACK.app" ]; then
            cp build/launcher_dist/VPACK.app/Contents/MacOS/VPACK dist/VPACK.app/Contents/MacOS/
          fi
          chmod +x dist/VPACK.app/Contents/MacOS/VPACK

          # Copy backend
          cp -r build/backend_dist/vpack-backend dist/VPACK.app/Contents/Resources/backend

          # Copy frontend
          mkdir -p dist/VPACK.app/Contents/Resources/frontend
          cp -r ../frontend-dist/standalone dist/VPACK.app/Contents/Resources/frontend/

          # Download Node.js for macOS
          ARCH=$(uname -m)
          if [ "$ARCH" = "arm64" ]; then
            NODE_ARCH="arm64"
          else
            NODE_ARCH="x64"
          fi
          NODE_VERSION="18.19.0"
          curl -L "https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-darwin-${NODE_ARCH}.tar.gz" -o node.tar.gz
          tar -xzf node.tar.gz
          cp node-v${NODE_VERSION}-darwin-${NODE_ARCH}/bin/node dist/VPACK.app/Contents/Resources/frontend/
          chmod +x dist/VPACK.app/Contents/Resources/frontend/node

          # Copy resources if exists
          if [ -d "resources" ]; then
            cp -r resources/* dist/VPACK.app/Contents/Resources/ || true
          fi
        working-directory: desktop

      - name: Validate macOS app bundle structure
        run: |
          echo "=========================================="
          echo "VALIDATING VPACK.app BUNDLE"
          echo "=========================================="

          # Check main structure
          echo "✓ Checking bundle structure..."
          test -d "dist/VPACK.app/Contents" || { echo "❌ Contents directory missing"; exit 1; }
          test -d "dist/VPACK.app/Contents/MacOS" || { echo "❌ MacOS directory missing"; exit 1; }
          test -d "dist/VPACK.app/Contents/Resources" || { echo "❌ Resources directory missing"; exit 1; }
          test -f "dist/VPACK.app/Contents/Info.plist" || { echo "❌ Info.plist missing"; exit 1; }
          echo "  ✅ Bundle structure OK"

          # Check main executable
          echo "✓ Checking main executable..."
          test -f "dist/VPACK.app/Contents/MacOS/VPACK" || { echo "❌ Main executable missing"; exit 1; }
          test -x "dist/VPACK.app/Contents/MacOS/VPACK" || { echo "❌ Main executable not executable"; exit 1; }
          file dist/VPACK.app/Contents/MacOS/VPACK
          echo "  ✅ Main executable OK"

          # Check backend
          echo "✓ Checking backend..."
          test -d "dist/VPACK.app/Contents/Resources/backend" || { echo "❌ Backend directory missing"; exit 1; }
          test -f "dist/VPACK.app/Contents/Resources/backend/vpack-backend" || { echo "❌ Backend executable missing"; exit 1; }
          test -x "dist/VPACK.app/Contents/Resources/backend/vpack-backend" || { echo "❌ Backend not executable"; exit 1; }
          echo "  ✅ Backend OK"

          # Check frontend
          echo "✓ Checking frontend..."
          test -d "dist/VPACK.app/Contents/Resources/frontend/standalone" || { echo "❌ Frontend standalone missing"; exit 1; }
          test -f "dist/VPACK.app/Contents/Resources/frontend/standalone/server.js" || { echo "❌ Frontend server.js missing"; exit 1; }
          test -f "dist/VPACK.app/Contents/Resources/frontend/node" || { echo "❌ Node executable missing"; exit 1; }
          test -x "dist/VPACK.app/Contents/Resources/frontend/node" || { echo "❌ Node not executable"; exit 1; }
          echo "  ✅ Frontend OK"

          # Check Info.plist
          echo "✓ Validating Info.plist..."
          plutil -lint dist/VPACK.app/Contents/Info.plist || { echo "❌ Info.plist invalid"; exit 1; }
          echo "  ✅ Info.plist valid"

          # Summary
          echo ""
          echo "=========================================="
          echo "BUNDLE VALIDATION PASSED ✅"
          echo "=========================================="
          echo ""
          echo "Bundle size:"
          du -sh dist/VPACK.app
          echo ""
          echo "Main components:"
          ls -lh dist/VPACK.app/Contents/MacOS/VPACK
          ls -lh dist/VPACK.app/Contents/Resources/backend/vpack-backend
          ls -lh dist/VPACK.app/Contents/Resources/frontend/node
          ls -lh dist/VPACK.app/Contents/Resources/frontend/standalone/server.js
        working-directory: desktop

      - name: Code sign and remove quarantine
        run: |
          # Remove extended attributes (quarantine)
          xattr -cr dist/VPACK.app

          # Make all binaries executable
          find dist/VPACK.app -type f -name "*.so" -exec chmod +x {} \;
          find dist/VPACK.app -type f -name "*.dylib" -exec chmod +x {} \;

          # Sign all nested binaries individually (better than --deep)
          echo "Signing nested binaries..."

          # Sign all .so files
          find dist/VPACK.app -type f -name "*.so" -exec codesign --force --sign - {} \;

          # Sign all .dylib files
          find dist/VPACK.app -type f -name "*.dylib" -exec codesign --force --sign - {} \;

          # Sign Python and Node executables
          find dist/VPACK.app -type f \( -name "python*" -o -name "node" \) -exec codesign --force --sign - {} \;

          # Sign the backend executable
          if [ -f "dist/VPACK.app/Contents/Resources/backend/vpack-backend" ]; then
            codesign --force --sign - dist/VPACK.app/Contents/Resources/backend/vpack-backend
          fi

          # Sign the main app last
          codesign --force --sign - dist/VPACK.app/Contents/MacOS/VPACK

          # Sign the entire bundle
          codesign --force --sign - dist/VPACK.app

          # Verify signing
          echo "Verifying signatures..."
          codesign --verify --verbose=2 dist/VPACK.app || echo "Verification warning (expected for ad-hoc)"

          # List what was signed
          echo "Signed binaries:"
          find dist/VPACK.app -type f \( -name "*.so" -o -name "*.dylib" -o -perm +111 \) | head -20
        working-directory: desktop

      - name: Create DMG
        run: |
          # Try create-dmg first, fallback to hdiutil
          if command -v create-dmg &> /dev/null; then
            create-dmg \
              --volname "VPACK" \
              --window-pos 200 120 \
              --window-size 600 400 \
              --icon-size 100 \
              --icon "VPACK.app" 150 190 \
              --hide-extension "VPACK.app" \
              --app-drop-link 450 190 \
              "dist/VPACK-${{ github.sha }}-macOS.dmg" \
              "dist/VPACK.app" || \
            hdiutil create -volname "VPACK" -srcfolder dist/VPACK.app -ov -format UDZO "dist/VPACK-${{ github.sha }}-macOS.dmg"
          else
            hdiutil create -volname "VPACK" -srcfolder dist/VPACK.app -ov -format UDZO "dist/VPACK-${{ github.sha }}-macOS.dmg"
          fi
        working-directory: desktop

      - name: Upload macOS DMG
        uses: actions/upload-artifact@v4
        with:
          name: VPACK-macOS-DMG
          path: desktop/dist/VPACK-*-macOS.dmg
          retention-days: 30

      - name: Upload macOS app (for debugging)
        uses: actions/upload-artifact@v4
        with:
          name: VPACK-macOS-App
          path: desktop/dist/VPACK.app/
          retention-days: 7

  # Create release (only on tags)
  release:
    name: Create Release
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/VPACK-Windows/*.zip
            artifacts/VPACK-macOS-DMG/*.dmg
          draft: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
