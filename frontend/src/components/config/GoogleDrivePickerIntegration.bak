// src/components/config/GoogleDrivePickerIntegration.js
// Google Drive Picker Integration Component - Auto-Auth & Native Picker Interface
import React, { useState, useEffect, useCallback } from 'react';

const GoogleDrivePickerIntegration = ({
  onFoldersSelected,
  credentials = null,
  multiSelect = true,
  disabled = false,
  className = '',
  userEmail = null
}) => {
  // Component state
  const [pickerApiLoaded, setPickerApiLoaded] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState(null);
  const [selectedFolders, setSelectedFolders] = useState([]);
  const [pickerToken, setPickerToken] = useState(null);
  const [isAuthenticated, setIsAuthenticated] = useState(false);

  // Check if Google APIs are available
  useEffect(() => {
    const checkGoogleApis = () => {
      if (window.gapi) {
        // Load the Picker API
        window.gapi.load('picker', {
          callback: () => {
            setPickerApiLoaded(true);
            console.log('‚úÖ Google Picker API loaded successfully');
          },
          onerror: (error) => {
            console.error('‚ùå Failed to load Google Picker API:', error);
            setError('Failed to load Google Picker API. Please refresh the page.');
          }
        });
      } else {
        // Retry after a short delay if gapi not available yet
        setTimeout(checkGoogleApis, 1000);
      }
    };

    checkGoogleApis();
  }, []);

  // Auto-authenticate flow
  const authenticateUser = useCallback(async () => {
    try {
      setError(null);
      console.log('üîê Starting auto-authentication...');

      // Step 1: Initiate authentication
      const authResponse = await fetch('http://localhost:8080/api/cloud/authenticate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          provider: 'google_drive',
          action: 'initiate_auth'
        })
      });

      if (!authResponse.ok) {
        throw new Error(`Auth initiation failed: ${authResponse.status}`);
      }

      const authResult = await authResponse.json();

      if (authResult.success && authResult.auth_url) {
        console.log('üåê Opening OAuth popup...');
        
        // Step 2: Open OAuth popup
        const popup = window.open(
          authResult.auth_url,
          'google_drive_auth',
          'width=600,height=700,scrollbars=yes,resizable=yes'
        );

        if (!popup) {
          throw new Error('Popup blocked. Please allow popups for this site.');
        }

        // Step 3: Wait for popup completion
        await new Promise((resolve, reject) => {
          const checkClosed = setInterval(() => {
            if (popup.closed) {
              clearInterval(checkClosed);
              resolve();
            }
          }, 1000);

          // Timeout after 5 minutes
          setTimeout(() => {
            clearInterval(checkClosed);
            if (!popup.closed) {
              popup.close();
            }
            reject(new Error('Authentication timeout'));
          }, 300000);
        });

        console.log('‚úÖ OAuth popup completed, checking auth status...');

        // Step 4: Check authentication result
        const statusResponse = await fetch('http://localhost:8080/api/cloud/auth-status');
        if (!statusResponse.ok) {
          throw new Error('Failed to check auth status');
        }

        const statusResult = await statusResponse.json();

        if (statusResult.success && statusResult.authenticated) {
          console.log('‚úÖ Authentication successful:', statusResult.user_email);
          setIsAuthenticated(true);
          return statusResult;
        } else {
          throw new Error(statusResult.message || 'Authentication failed');
        }

      } else {
        throw new Error(authResult.message || 'Auth initiation failed');
      }

    } catch (error) {
      console.error('‚ùå Authentication error:', error);
      setError(`Authentication failed: ${error.message}`);
      return null;
    }
  }, []);

  // Get Picker token from backend
  const getPickerToken = useCallback(async () => {
    try {
      setError(null);
      
      const response = await fetch('http://localhost:8080/api/cloud/picker-token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          provider: 'google_drive',
          user_email: userEmail
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `HTTP ${response.status}`);
      }

      const tokenData = await response.json();
      
      if (!tokenData.success) {
        throw new Error(tokenData.message || 'Failed to get picker token');
      }

      console.log('‚úÖ Picker token obtained successfully');
      return tokenData.picker_token;
      
    } catch (error) {
      console.error('‚ùå Error getting picker token:', error);
      setError(`Failed to get access token: ${error.message}`);
      return null;
    }
  }, [userEmail]);

  // Create and configure Google Picker
  const createPicker = useCallback((accessToken) => {
    if (!window.google || !window.google.picker) {
      setError('Google Picker API not available');
      return null;
    }

    try {
    // Create picker builder
    const picker = new window.google.picker.PickerBuilder()
      .addView(window.google.picker.ViewId.FOLDERS)
      .setOAuthToken(accessToken)
      .setCallback(handlePickerCallback)
      .setTitle('Select Camera Folders from Google Drive')
      .setSize(800, 600);

    // Enable multiselect if requested
    if (multiSelect) {
      picker.enableFeature(window.google.picker.Feature.MULTISELECT_ENABLED);
    }

    // Enable navigation
    picker.enableFeature(window.google.picker.Feature.NAV_HIDDEN);

    console.log('‚úÖ Google Picker created successfully');
    return picker.build();
      
    } catch (error) {
      console.error('‚ùå Error creating picker:', error);
      setError(`Failed to create picker: ${error.message}`);
      return null;
    }
  }, [multiSelect]);

  // Handle picker callback
  const handlePickerCallback = useCallback((data) => {
    console.log('üîÑ Picker callback received:', data);
    
    if (data.action === window.google.picker.Action.PICKED) {
      try {
        const selectedDocs = data.docs || [];
        
        // Process selected folders
        const folders = selectedDocs.map(doc => ({
          id: doc.id,
          name: doc.name,
          url: doc.url,
          type: 'folder',
          mimeType: doc.mimeType,
          lastEditedUtc: doc.lastEditedUtc,
          iconUrl: doc.iconUrl,
          description: doc.description || '',
          sizeBytes: doc.sizeBytes || 0
        }));

        console.log(`‚úÖ Selected ${folders.length} folder(s):`, folders);
        
        setSelectedFolders(folders);
        setError(null);

        // Notify parent component
        if (onFoldersSelected) {
          onFoldersSelected(folders);
        }

      } catch (error) {
        console.error('‚ùå Error processing picker selection:', error);
        setError(`Failed to process selection: ${error.message}`);
      }
    } else if (data.action === window.google.picker.Action.CANCEL) {
      console.log('üö´ Picker cancelled by user');
      setError(null);
    } else {
      console.log('‚ÑπÔ∏è Picker action:', data.action);
    }
  }, [onFoldersSelected]);

  // Main function to open picker with auto-auth
  const openPickerWithAuth = useCallback(async () => {
    if (!pickerApiLoaded) {
      setError('Google Picker API is still loading. Please try again in a moment.');
      return;
    }

    setIsLoading(true);
    setError(null);

    try {
      console.log('üéØ Starting picker flow with auto-auth...');

      // Step 1: Try to get picker token (may fail if not authenticated)
      let token = await getPickerToken();
      
      if (!token) {
        console.log('üîê No token available, starting authentication...');
        
        // Step 2: Authenticate user if no token
        const authResult = await authenticateUser();
        if (!authResult) {
          setIsLoading(false);
          return;
        }

        // Step 3: Get token after authentication
        token = await getPickerToken();
        if (!token) {
          setError('Failed to get picker token after authentication');
          setIsLoading(false);
          return;
        }
      }

      setPickerToken(token);

      // Step 4: Create and show picker
      const picker = createPicker(token);
      
      if (picker) {
        console.log('üéØ Opening Google Drive Picker...');
        picker.setVisible(true);
      }

    } catch (error) {
      console.error('‚ùå Error in picker flow:', error);
      setError(`Failed to open picker: ${error.message}`);
    } finally {
      setIsLoading(false);
    }
  }, [pickerApiLoaded, getPickerToken, authenticateUser, createPicker]);

  // Clear error
  const clearError = () => {
    setError(null);
  };

  // Clear selected folders
  const clearSelection = () => {
    setSelectedFolders([]);
    if (onFoldersSelected) {
      onFoldersSelected([]);
    }
  };

  // Component render
  return (
    <div className={`google-drive-picker-integration ${className}`}>
      
      {/* Main Picker Button */}
      <div className="picker-controls mb-4">
        <button
          onClick={openPickerWithAuth}
          disabled={disabled || isLoading || !pickerApiLoaded}
          className={`px-6 py-3 rounded-lg font-medium transition-all duration-200 ${
            disabled || isLoading || !pickerApiLoaded
              ? 'bg-gray-400 text-gray-600 cursor-not-allowed'
              : 'bg-blue-600 hover:bg-blue-700 text-white shadow-lg hover:shadow-xl transform hover:scale-105'
          }`}
        >
          {isLoading ? (
            <span className="flex items-center">
              <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              {isAuthenticated ? 'Opening Picker...' : 'Authenticating...'}
            </span>
          ) : (
            <span className="flex items-center">
              üìÅ Browse Google Drive Folders
              {!pickerApiLoaded && (
                <span className="ml-2 text-xs opacity-75">(Loading...)</span>
              )}
            </span>
          )}
        </button>

        {/* Status Indicators */}
        <div className="mt-2 text-xs text-gray-400">
          <span className={`inline-block w-2 h-2 rounded-full mr-2 ${
            pickerApiLoaded ? 'bg-green-500' : 'bg-yellow-500'
          }`}></span>
          {pickerApiLoaded ? 'Picker API Ready' : 'Loading Picker API...'}
          
          {isAuthenticated && (
            <>
              <span className="inline-block w-2 h-2 rounded-full bg-green-500 mr-2 ml-4"></span>
              Google Drive Connected
            </>
          )}
        </div>
      </div>

      {/* Error Display */}
      {error && (
        <div className="error-display mb-4 p-4 bg-red-100 border border-red-400 rounded-lg">
          <div className="flex items-center justify-between">
            <div className="text-red-700">
              <div className="font-medium">‚ö†Ô∏è Error</div>
              <div className="text-sm mt-1">{error}</div>
            </div>
            <button
              onClick={clearError}
              className="text-red-500 hover:text-red-700 text-lg leading-none"
            >
              √ó
            </button>
          </div>
          
          {/* Error Actions */}
          <div className="mt-3 flex gap-2">
            <button
              onClick={() => window.location.reload()}
              className="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700"
            >
              Refresh Page
            </button>
            <button
              onClick={openPickerWithAuth}
              className="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700"
            >
              Try Again
            </button>
          </div>
        </div>
      )}

      {/* Selected Folders Display */}
      {selectedFolders.length > 0 && (
        <div className="selected-folders mb-4 p-4 bg-green-100 border border-green-400 rounded-lg">
          <div className="flex items-center justify-between mb-3">
            <h4 className="font-medium text-green-800">
              ‚úÖ Selected Folders ({selectedFolders.length})
            </h4>
            <button
              onClick={clearSelection}
              className="text-green-600 hover:text-green-800 text-sm"
            >
              Clear Selection
            </button>
          </div>
          
          <div className="space-y-2">
            {selectedFolders.map((folder, index) => (
              <div key={folder.id} className="flex items-center gap-3 p-2 bg-white rounded border">
                <span className="text-lg">üìÅ</span>
                <div className="flex-1 min-w-0">
                  <div className="font-medium text-gray-900 truncate">
                    {folder.name}
                  </div>
                  <div className="text-xs text-gray-500 truncate">
                    ID: {folder.id}
                  </div>
                </div>
                <div className="text-xs text-gray-400">
                  {folder.sizeBytes > 0 && (
                    <span>{(folder.sizeBytes / 1024 / 1024).toFixed(1)} MB</span>
                  )}
                </div>
              </div>
            ))}
          </div>

          <div className="mt-3 text-xs text-green-700">
            üí° These folders will be used as camera sources for VTrack video processing
          </div>
        </div>
      )}

      {/* Help Text */}
      {selectedFolders.length === 0 && !error && (
        <div className="help-text p-4 bg-blue-50 border border-blue-200 rounded-lg">
          <h4 className="font-medium text-blue-800 mb-2">üìñ How to use Google Drive Picker:</h4>
          <ul className="text-sm text-blue-700 space-y-1">
            <li>‚Ä¢ Click "Browse Google Drive Folders" to authenticate & open picker</li>
            <li>‚Ä¢ First time: Google login popup will appear automatically</li>
            <li>‚Ä¢ Select folders that contain your camera videos</li>
            <li>‚Ä¢ Use Ctrl/Cmd+Click to select multiple folders</li>
            <li>‚Ä¢ Selected folders will be synced to VTrack for processing</li>
          </ul>
        </div>
      )}

      {/* Debug Info (Development Only) */}
      {process.env.NODE_ENV === 'development' && (
        <details className="debug-info mt-4 p-3 bg-gray-100 rounded text-xs">
          <summary className="cursor-pointer text-gray-600">üîß Debug Info</summary>
          <pre className="mt-2 text-gray-500 overflow-auto">
            {JSON.stringify({
              pickerApiLoaded,
              isAuthenticated,
              isLoading,
              hasError: !!error,
              selectedCount: selectedFolders.length,
              hasToken: !!pickerToken,
              userEmail: userEmail || 'auto-detect',
              multiSelect,
              disabled
            }, null, 2)}
          </pre>
        </details>
      )}
    </div>
  );
};

export default GoogleDrivePickerIntegration;
daigfdsi
avdabkv
