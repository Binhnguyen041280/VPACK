<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ePACK - ƒêang x·ª≠ l√Ω thanh to√°n</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
            margin: 20px;
        }
        .icon {
            font-size: 64px;
            color: #2196f3;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        p {
            color: #666;
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 20px;
        }
        .countdown {
            color: #2196f3;
            font-weight: bold;
            font-size: 18px;
        }
        .hidden {
            display: none;
        }
        .manual-close-btn {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 14px;
        }
        .manual-close-btn:hover {
            background: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">üí≥</div>
        <h1>ƒêang x·ª≠ l√Ω thanh to√°n</h1>
        <p>C·ª≠a s·ªï s·∫Ω t·ª± ƒë·ªông ƒë√≥ng sau <span id="countdown" class="countdown">2</span> gi√¢y...</p>
        <p id="manual-note" class="hidden">
            <small>N·∫øu c·ª≠a s·ªï kh√¥ng ƒë√≥ng t·ª± ƒë·ªông:</small><br>
            <button id="manual-close-btn" class="manual-close-btn">ƒê√≥ng c·ª≠a s·ªï</button>
        </p>
    </div>

    <script>
        // FIXED: Silent auto-close without browser notifications
        let countdown = 2; // Reduced from 3 to 2 seconds for faster UX
        const countdownEl = document.getElementById('countdown');
        const manualNote = document.getElementById('manual-note');
        const manualCloseBtn = document.getElementById('manual-close-btn');
        
        // Immediate close attempt for fastest user experience (100ms)
        setTimeout(() => {
            attemptClose('immediate');
        }, 100);
        
        // Backup close attempt after 500ms
        setTimeout(() => {
            attemptClose('backup');
        }, 500);
        
        // Main countdown timer
        const timer = setInterval(() => {
            countdown--;
            if (countdownEl) {
                countdownEl.textContent = countdown;
            }
            
            if (countdown <= 0) {
                clearInterval(timer);
                attemptClose('countdown');
            }
        }, 1000);
        
        // Manual close button handler
        if (manualCloseBtn) {
            manualCloseBtn.addEventListener('click', () => {
                attemptClose('manual');
            });
        }
        
        /**
         * Unified close attempt function
         * @param {string} source - Source of close attempt for debugging
         */
        function attemptClose(source) {
            try {
                console.log(`üîÑ Close attempt from: ${source}`);
                
                if (window.opener) {
                    // Send completion message to parent window
                    window.opener.postMessage({
                        type: 'payment_flow_completed',
                        source: 'payos_redirect',
                        timestamp: new Date().toISOString(),
                        close_source: source
                    }, '*');
                    
                    // Small delay to ensure message is sent
                    setTimeout(() => {
                        window.close();
                    }, 50);
                    
                } else if (window.parent !== window) {
                    // If in iframe, notify parent
                    window.parent.postMessage({
                        type: 'payment_flow_completed',
                        source: 'payos_redirect_iframe',
                        timestamp: new Date().toISOString()
                    }, '*');
                    
                } else {
                    // Not a popup or iframe - redirect to React app
                    console.log('üîÑ Redirecting to React app...');
                    window.location.href = 'http://localhost:3000';
                }
                
            } catch (error) {
                console.error(`‚ùå Close attempt failed (${source}):`, error);
                
                // Show manual close option if auto-close fails
                if (source === 'countdown' && manualNote) {
                    manualNote.classList.remove('hidden');
                }
                
                // Final fallback: redirect after showing manual option
                if (source === 'manual') {
                    window.location.href = 'http://localhost:3000';
                }
            }
        }
        
        // Enhanced close methods with fallbacks
        const enhancedCloseAttempts = () => {
            const attempts = [
                // Method 1: Standard window.close()
                () => {
                    if (window.close) {
                        window.close();
                    }
                },
                
                // Method 2: Focus parent then close
                () => {
                    if (window.opener) {
                        window.opener.focus();
                        window.close();
                    }
                },
                
                // Method 3: History back
                () => {
                    if (window.history.length > 1) {
                        window.history.back();
                    }
                },
                
                // Method 4: Force redirect
                () => {
                    window.location.replace('http://localhost:3000');
                }
            ];
            
            attempts.forEach((attempt, index) => {
                setTimeout(() => {
                    try {
                        attempt();
                    } catch (e) {
                        console.log(`Close method ${index + 1} failed, trying next...`);
                    }
                }, (index + 1) * 300); // Stagger attempts
            });
        };
        
        // Run enhanced close attempts after 3 seconds if still open
        setTimeout(() => {
            if (!document.hidden && document.visibilityState === 'visible') {
                enhancedCloseAttempts();
            }
        }, 3000);
        
        // Listen for visibility changes (user switches tabs)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // User switched away - try to close
                attemptClose('visibility_change');
            }
        });
        
        // Listen for beforeunload to send final message
        window.addEventListener('beforeunload', () => {
            try {
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'payment_flow_completed',
                        source: 'manual_close',
                        timestamp: new Date().toISOString()
                    }, '*');
                }
            } catch (e) {
                // Silent fail
            }
        });
        
        // Prevent right-click and F12 to reduce user confusion
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', (e) => {
            // Block developer tools
            if (e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.shiftKey && e.key === 'C')) {
                e.preventDefault();
            }
            
            // Allow Escape to close
            if (e.key === 'Escape') {
                attemptClose('escape_key');
            }
        });
        
        // Auto-focus for better keyboard accessibility
        window.addEventListener('load', () => {
            if (manualCloseBtn) {
                setTimeout(() => {
                    manualCloseBtn.focus();
                }, 2500); // Focus after countdown
            }
        });
        
        // Debug information (only in console, no alerts)
        console.log('üöÄ ePACK Payment Redirect Page Loaded');
        console.log('üì± User Agent:', navigator.userAgent);
        console.log('üîó Referrer:', document.referrer);
        console.log('üåê Is Popup:', !!window.opener);
        console.log('üìã Window Name:', window.name);
    </script>
</body>
</html>